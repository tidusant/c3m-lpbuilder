<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Landing page builder</title>

    <link href="/scheme/dragula.css" rel="stylesheet">
    <link href="/scheme/cus.css" rel="stylesheet">
    {{customcss}}
</head>
<body class="blur-theme">
<div class="grid grid-flow-col grid-cols-12 w-full">
    <div class="py-2 text-gray-900 bg-white rounded-lg shadow-lg">
        <div lp-data-id="landingpage-itemcontent" class="fixed w-1/12 z-30 text-center">
            <button onClick="window.location='/'" type="button" class="btn btn-primary btn-xs m-auto">Back</button>
            <button onClick="PreviewMode()" type="button" class="btn btn-primary btn-xs m-auto">Preview</button>
            <div class="border-b py-1"></div>

            <div class="landingpage-pickzone">
                {{toolcontent}}
            </div>
        </div>
        <div lp-data-id="landingpage-previewitemcontent" class="fixed w-1/12 z-30 text-center hidden">
            <button onClick="PreviewMode(false)" type="button" class="btn btn-primary btn-xs m-auto">Back</button>
            <div class="border-b py-1"></div>

            <div class="py-2 m-auto">
                <button onclick="ChangePreviewMode(1)">
                <svg viewBox="0 0 12 20" class="ResponseSwitchers__itemIcon----1nyd" width="20" height="20"><g><use xlink:href="#responseMobile_svg__path0_fill"></use><use xlink:href="#responseMobile_svg__path1_fill"></use><use xlink:href="#responseMobile_svg__path2_fill"></use></g><defs><path id="responseMobile_svg__path0_fill" fill-rule="evenodd" d="M2.152 1C1.516 1 1 1.516 1 2.152v15.696C1 18.484 1.516 19 2.152 19h7.435c.636 0 1.152-.516 1.152-1.152V2.152C10.74 1.516 10.223 1 9.587 1H2.152zM0 2.152C0 .964.963 0 2.152 0h7.435c1.19 0 2.152.964 2.152 2.152v15.696A2.152 2.152 0 019.587 20H2.152A2.152 2.152 0 010 17.848V2.152z"></path><path id="responseMobile_svg__path1_fill" fill-rule="evenodd" d="M3.304 2.152a.5.5 0 01.5-.5h4.13a.5.5 0 110 1h-4.13a.5.5 0 01-.5-.5z"></path><path id="responseMobile_svg__path2_fill" fill-rule="evenodd" d="M5.87 17.935a.087.087 0 100-.174v.174zm0 .826a.913.913 0 110-1.826.913.913 0 010 1.826z"></path></defs></svg>
                </button>
            </div>
            <div class="py-2 m-auto">
                <button onclick="ChangePreviewMode(2)">
                <svg viewBox="0 0 20 20" class="ResponseSwitchers__itemIcon----1nyd" width="20" height="20"><path fill-rule="evenodd" clip-rule="evenodd" d="M4.152 1C3.517 1 3 1.516 3 2.152v15.696C3 18.484 3.517 19 4.152 19h10.74c.636 0 1.152-.516 1.152-1.152V2.152c0-.636-.516-1.152-1.153-1.152H4.152zM2 2.152C2 .964 2.965 0 4.152 0h10.74c1.188 0 2.152.964 2.152 2.152v15.696A2.152 2.152 0 0114.89 20H4.152A2.153 2.153 0 012 17.848V2.152z"></path><path fill-rule="evenodd" clip-rule="evenodd" d="M9.521 1.326a.413.413 0 100 .827.413.413 0 000-.827zM9.521 17.935a.087.087 0 100-.174.087.087 0 000 .174zm-.913-.087a.913.913 0 111.827 0 .913.913 0 01-1.827 0z"></path></svg>
                </button>
            </div>
            <div class="py-2 m-auto">
                <button onclick="ChangePreviewMode(3)">
                    <svg viewBox="0 0 20 20" class="ResponseSwitchers__itemIcon----1nyd" width="20" height="20"><g><use xlink:href="#responseDesktop_svg__path0_fill"></use><use xlink:href="#responseDesktop_svg__path1_fill"></use><use xlink:href="#responseDesktop_svg__path2_fill"></use></g><defs><path id="responseDesktop_svg__path0_fill" fill-rule="evenodd" d="M1.74 1.063c-.382 0-.74.358-.74.863v13.018c0 .505.358.863.74.863h16.52c.383 0 .74-.357.74-.863V1.926c0-.506-.357-.863-.74-.863H1.74zM0 1.926C0 .891.753 0 1.74 0h16.52C19.249 0 20 .891 20 1.926v13.018c0 1.035-.752 1.926-1.74 1.926H1.74c-.987 0-1.74-.891-1.74-1.926V1.926z"></path><path id="responseDesktop_svg__path1_fill" fill-rule="evenodd" d="M3.717 19.5a.5.5 0 01.5-.5h11.566a.5.5 0 010 1H4.216a.5.5 0 01-.5-.5z"></path><path id="responseDesktop_svg__path2_fill" fill-rule="evenodd" d="M10 15.87c.276 0 .5.308.5.688v2.273c0 .38-.224.689-.5.689s-.5-.308-.5-.689v-2.273c0-.38.224-.688.5-.688z"></path></defs></svg>
                </button>
            </div>
        </div>
    </div>
    <div class="min-h-screen col-span-11 border-t border-b sm:rounded sm:border shadow">
        <div lp-data-id="landingpage-content" >{{pagecontent}}</div>
        <div lp-data-id="landingpage-previewcontent" class="hidden landingpage-preview-tabletframe">
        <iframe id="preview" >
        </iframe>
        </div>

    </div>
</div>


<div class="btnmodal h-screen w-full fixed left-0 top-0 flex justify-center items-center bg-black bg-opacity-50 hidden">
    <!-- modal -->
    <div class="bg-white rounded shadow-lg w-1/3">
        <!-- modal header -->
        <div class="border-b px-4 py-2 flex justify-between items-center">
            <h3 class="font-semibold text-lg">Change Item Link</h3>
            <button class="text-black close-modal">&cross;</button>
        </div>
        <!-- modal body -->
        <div class="p-3">

            <label for="btnTitle" class="text-gray-700">Title</label>
            <input class="border rounded p-1 form-input mt-1 block w-full" id="modalInputTitle" placeholder="input title" />
            <label for="btnUrl" class="text-gray-700">Url</label>
            <input class="border rounded p-1 form-input mt-1 block w-full" id="modalInputUrl" placeholder="input url" />
            <label for="btnUrl" class="text-gray-700">Inner Text</label>
            <textarea class="border rounded p-1 form-input mt-1 block w-full" id="modalInputText" placeholder="text"></textarea>
        </div>
        <div class="flex justify-end items-center w-100 border-t p-3">
            <button class="bg-red-600 hover:bg-red-700 px-3 py-1 rounded text-white mr-1 close-modal">Cancel</button>
            <button class="bg-blue-600 hover:bg-blue-700 px-3 py-1 rounded text-white submit-modal">Ok</button>
        </div>
    </div>
</div>

{{customjs}}
<script src="/scheme/dragula.min.js"></script>
<script>
    //==========modal script

    const btnmodal = document.querySelector('.btnmodal');
    const closeModal = document.querySelectorAll('.close-modal');
    const submitModal = document.querySelectorAll('.submit-modal');
    let fnAfterSubmitModal=()=>{}
    function showModal(title,url,text) {
        document.querySelector("#modalInputTitle").value=title
        document.querySelector("#modalInputUrl").value=url
        document.querySelector("#modalInputText").value=text
        btnmodal.classList.remove('hidden')
    }

    closeModal.forEach(close => {
        close.addEventListener('click', function (){
            btnmodal.classList.add('hidden')
        });
    });

    submitModal.forEach(evt => {
        evt.addEventListener('click', (e)=>{
            fnAfterSubmitModal()
            btnmodal.classList.add('hidden')
        });
    });

    //=====================
    const MTools={{mtoolcontent}}
        const navitemtemplate=`{{navitemtemplate}}`
    console.log(MTools)
    const drake=dragula([document.querySelector("div.landingpage-pickzone"),...document.querySelectorAll("div.drop-zone"),document.querySelector("div.mega-menu")],{
        copy: function (el, target) {
            return !target.classList.contains("drop-zone")

        },
        moves: function (el, source, handle, sibling) {
            if(el.classList.contains("cus-not-draggable"))return false
            return true; // elements are always draggable by default
        },

        copySortSource: false,
        accepts: function (el, target, source, sibling) {

            return target.classList.contains("drop-zone")
            //return true; // elements can be dropped in any of the `containers` by default
        },
    });

    drake.on('shadow', (el, target, source) => {
        console.log(el,target,source)

        if(!target||!target.classList.contains("drop-zone"))return
        if(!source||!(source.classList.contains("landingpage-pickzone")||source.classList.contains("mega-menu")))return
        el.className="m-auto landingpage-cursor-pointer relative gu-transit"

        console.log(el.getAttribute("lp-data-id"))
        const content=MTools[el.getAttribute("lp-data-id").replace("landingpage-tool-","")]

        el.innerHTML=content
    })
    drake.on('drop', (el, target, source,sibling) => {
        if(!target||!target.classList.contains("drop-zone"))return
        if(!source||!(source.classList.contains("landingpage-pickzone")||source.classList.contains("mega-menu")))return
        if(el.getAttribute("lp-data-id")=="a"){
            //generate nav item
            const name=prompt("Navigation Name:","")
            if(name!=null&&name.trim()!=""){
                const id=name.replace(" ","-")
                const content=navitemtemplate.replace(new RegExp("\{\{Id\}\}","gm"),id).replace(new RegExp("\{\{Name\}\}","gm"),name)
                const navels=document.querySelectorAll(".landingpage-navitem-content")
                for(let i=0,n=navels.length;i<n;i++){
                    navels[i].innerHTML+=content
                    checkEditable(navels[i])
                }
                el.setAttribute("lp-data-id","a_"+id+"_"+name)
                //replace trashtitle token
                //replace trashtitle token
                el.innerHTML=el.innerHTML.replace(new RegExp("\{\{Id\}\}","gm"),id).replace(new RegExp("\{\{Name\}\}","gm"),name).replace(new RegExp("\{\{trashtitle\}\}","gm"),name)
            }else{
                return false
            }
        }
        //replace trashtitle token for other
        el.innerHTML=el.innerHTML.replace(new RegExp("\{\{trashtitle\}\}","gm"),"")
        checkEditable(el)
    })



    function changeButtonOnclickEvent(btnEl){
        btnEl.onclick=(e)=>{
            e.preventDefault()
            let buttonurl=btnEl.getAttribute("onclick")
            let buttontitle=btnEl.getAttribute("title")
            console.log(btnEl)
            let innerText=btnEl.innerHTML
            if(buttonurl)
                buttonurl=buttonurl.replace("window.location=","").replace(/['"]/g,"")
            else buttonurl="#"
            // const newurl=prompt("change url:",buttonurl)
            // if(newurl!=null)
            //     btnEl.setAttribute(`onclick`,`window.location='`+newurl+`'`)

            fnAfterSubmitModal=()=>{
                btnEl.setAttribute(`onclick`,`window.location='`+document.querySelector("#modalInputUrl").value+`'`)
                btnEl.setAttribute(`title`,document.querySelector("#modalInputTitle").value)
                btnEl.innerHTML=document.querySelector("#modalInputText").value
                changeButtonOnclickEvent(btnEl)
            }
            showModal(buttonurl,buttontitle,innerText)
            //call recursive to apply new attribute value

        }
    }
    function checkEditable(el){
        if(el.classList.contains("element-not-editable"))return
        if(el.tagName=="A"){
            el.onclick=(e)=>{
                e.preventDefault()
                fnAfterSubmitModal=()=>{
                    el.href=document.querySelector("#modalInputUrl").value
                    el.title=document.querySelector("#modalInputTitle").value
                    el.innerHTML=document.querySelector("#modalInputText").value
                    el.focus()
                }
                showModal(el.title,el.href,el.innerHTML)
            }

        }
        if(el.tagName=="IMG"){
            el.onclick=(e)=>{
                e.preventDefault()
                fnAfterSubmitModal=()=>{
                    el.src=document.querySelector("#modalInputUrl").value
                    el.title=document.querySelector("#modalInputTitle").value
                    //el.innerHTML=document.querySelector("#modalInputText").value
                    //el.focus()
                }
                showModal(el.title,el.src,"N/A")
            }
        }
        if(el.tagName=="BUTTON"){
            changeButtonOnclickEvent(el)
        }
        if(el.childElementCount>0){
            if(el.tagName=="P"){
             el.contentEditable=true
            }
                for (let i = 0, n = el.childElementCount; i < n; i++)
                    checkEditable(el.children[i])

        }else{
            //check if have text
            if(el.innerText!=""){
                el.contentEditable=true
            }
        }
    }
    function RemoveItem(el){
        const vtypes=el.parentNode.getAttribute("lp-data-id").split("_")
        if(vtypes.length>0){
            if(vtypes[0]=="a"){
                document.querySelector("[lp-data-id=landingpage-navitem-"+vtypes[1]+"]").remove()
            }
        }
        el.parentNode.remove()
    }

    function DisableContentEditable(){
        document.querySelectorAll(`[contenteditable]`).forEach(el=>{
            el.contentEditable=false
        })
    }
    function PreviewMode(enable){
        enable=enable==undefined?true:enable
        const contentEl = document.querySelector("div[lp-data-id=landingpage-content]")
        const ifr = document.querySelector("iframe#preview")
        const previewcontent=document.querySelector("div[lp-data-id=landingpage-previewcontent]")
        const toolcontent=document.querySelector("div[lp-data-id=landingpage-itemcontent]")
        const previewtoolcontent=document.querySelector("div[lp-data-id=landingpage-previewitemcontent]")
        if(enable) {
            DisableContentEditable()
            const previewContent = `<!DOCTYPE html><html lang="en"><head>{{customcss}}</head><body>`
            const endContent= `{{customiframejs}}</body></html>`
            let content=contentEl.innerHTML
            //remove trash button content
            content=content.replace(/<div class="landingpage-trash .*?<\/div>.*?<\/div>/gsi,``)
            //remove lp-data-id attr
            content=content.replace(/lp-data-id="(.*?)"/gi,``)

            ifr.contentWindow.document.open();
            ifr.contentWindow.document.write(previewContent + content + endContent);
            ifr.contentWindow.document.close();

            contentEl.classList.add("hidden")
            previewcontent.classList.remove("hidden")
            toolcontent.classList.add("hidden")
            previewtoolcontent.classList.remove("hidden")
            ChangePreviewMode(3)
        }else{
            contentEl.classList.remove("hidden")
            previewcontent.classList.add("hidden")
            toolcontent.classList.remove("hidden")
            previewtoolcontent.classList.add("hidden")
            checkEditable(document.querySelector("div[lp-data-id=landingpage-content]"))
        }
    }

    function ChangePreviewMode(mode){
        const ifr = document.querySelector("iframe#preview")
        const divcontent=document.querySelector("div[lp-data-id=landingpage-previewcontent]")
        if(mode==1){
            ifr.className="landingpage-mobileframe-content"
            divcontent.className="landingpage-preview-mobileframe"
        }else if(mode==2){
            ifr.className="landingpage-tabletframe-content"
            divcontent.className="landingpage-preview-tabletframe"

        }else if(mode==3){
            ifr.className="h-full w-full"
            divcontent.className="h-full"
        }
    }

    PreviewMode(false)

</script>
</body>
</html>